# åç«¯æ–°å¢æ–‡ä»¶æ ¼å¼æ”¯æŒå¼€å‘æŒ‡å—

æœ¬æ–‡æ¡£æ—¨åœ¨ä¸ºå¼€å‘è€…æä¾›ä¸€ä¸ªæ¸…æ™°çš„æµç¨‹ï¼ŒæŒ‡å¯¼å¦‚ä½•ä¸ºåç«¯æœåŠ¡æ·»åŠ å¯¹æ–°é…ç½®æ–‡ä»¶æ ¼å¼ï¼ˆå¦‚`.bmd`, `.some_other_format`ï¼‰çš„æ”¯æŒã€‚æˆ‘ä»¬çš„æ ¸å¿ƒæ¶æ„ä¼˜åŠ¿åœ¨äºï¼š**åç«¯æä¾›ç»Ÿä¸€çš„JSONæ•°æ®ç»“æ„ï¼Œå‰ç«¯ï¼ˆæˆ–æµ‹è¯•GUIï¼‰å®Œå…¨æ— éœ€æ”¹åŠ¨**ã€‚

éµå¾ªæœ¬æŒ‡å—ï¼Œæ‚¨å¯ä»¥å®ç°å¯¹æ–°æ ¼å¼çš„"æ— ç¼å…¼å®¹"ã€‚

## æ ¸å¿ƒæ¶æ„ç†å¿µ

1.  **ç»Ÿä¸€å…¥å£**: `python-backend/cli_wrapper.py` æ˜¯æ‰€æœ‰æ–‡ä»¶è§£æä»»åŠ¡çš„å”¯ä¸€å…¥å£ã€‚æ— è®ºæ˜¯VS Codeå‰ç«¯è¿˜æ˜¯æµ‹è¯•GUIï¼Œéƒ½é€šè¿‡æ­¤è„šæœ¬ä¸åç«¯äº¤äº’ã€‚
2.  **ç»Ÿä¸€æ•°æ®å¥‘çº¦**: åç«¯æ— è®ºè§£æä½•ç§æ–‡ä»¶ï¼ˆARXML, BMD, XDM, XMLï¼‰ï¼Œéƒ½å¿…é¡»è¾“å‡ºä¸€ä¸ªæ ‡å‡†åŒ–çš„JSONå¯¹è±¡ã€‚è¿™ä¿è¯äº†ä»»ä½•æ¶ˆè´¹æ–¹ï¼ˆå‰ç«¯ã€GUIï¼‰éƒ½ä½¿ç”¨åŒæ ·çš„æ–¹å¼å¤„ç†æ•°æ®ã€‚
3.  **å‰ç«¯/GUIé›¶æ”¹åŠ¨**: ç”±äºæ•°æ®å¥‘çº¦æ˜¯ç»Ÿä¸€çš„ï¼Œå½“åç«¯æ”¯æŒäº†æ–°æ ¼å¼åï¼Œå‰ç«¯å’ŒGUI**å®Œå…¨ä¸éœ€è¦**ä»»ä½•ä¿®æ”¹å°±èƒ½è‡ªåŠ¨æ”¯æŒæ–°æ ¼å¼çš„è§£æå’Œæ˜¾ç¤ºã€‚

## æ–°å¢æ–‡ä»¶æ ¼å¼çš„æ­¥éª¤

è®©æˆ‘ä»¬ä»¥æˆåŠŸæ·»åŠ `.bmd`æ–‡ä»¶æ”¯æŒçš„ç»éªŒä¸ºä¾‹ï¼Œæ¼”ç¤ºæ·»åŠ æ–°æ ¼å¼çš„"ä¸‰æ­¥èµ°"æµç¨‹ã€‚

### ç¬¬ä¸€æ­¥ï¼šä¿®æ”¹æ–‡ä»¶ç±»å‹æ£€æµ‹

-   **æ–‡ä»¶**: `python-backend/processors.py`
-   **æ–¹æ³•**: `_detect_file_type(self, file_path: Path) -> str`

è¿™æ˜¯æ‰€æœ‰è§£æé€»è¾‘çš„èµ·ç‚¹ã€‚åœ¨æ­¤æ–¹æ³•ä¸­ï¼Œä¸ºæ–°çš„æ–‡ä»¶æ‰©å±•åæ·»åŠ ä¸€ä¸ªè¯†åˆ«åˆ†æ”¯ã€‚

**ç¤ºä¾‹ï¼šæ·»åŠ `.bmd`æ”¯æŒ**
```python
# ... in processors.py
def _detect_file_type(self, file_path: Path) -> str:
    """æ£€æµ‹æ–‡ä»¶ç±»å‹"""
    suffix = file_path.suffix.lower()
    if suffix == ".arxml":
        return "arxml"
    elif suffix == ".bmd":  # <-- æ–°å¢çš„åˆ†æ”¯
        return "bmd"
    elif suffix == ".xdm":
        return "xdm"
    else:
        return "xml"
```

### ç¬¬äºŒæ­¥ï¼šæ·»åŠ æ–‡ä»¶å¤„ç†é€»è¾‘

-   **æ–‡ä»¶**: `python-backend/processors.py`
-   **æ–¹æ³•**: `parse_file(self, file_path: str) -> Dict[str, Any]`

åœ¨è¯†åˆ«å‡ºæ–‡ä»¶ç±»å‹åï¼Œéœ€è¦åœ¨è¿™é‡Œå†³å®šè°ƒç”¨å“ªä¸ªè§£æå‡½æ•°ã€‚

**ç¤ºä¾‹ï¼šä¸º`bmd`ç±»å‹æŒ‡å®šè§£æå™¨**

`.bmd`æ–‡ä»¶çš„ç»“æ„ä¸`.arxml`å…¼å®¹ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å¤ç”¨ç°æœ‰çš„`_parse_arxml_file`æ–¹æ³•ã€‚å…³é”®åœ¨äº**å¿…é¡»æŠŠæ­£ç¡®çš„æ–‡ä»¶ç±»å‹ï¼ˆ"bmd"ï¼‰ä¼ é€’ç»™è§£æå‡½æ•°**ï¼Œä»¥ç¡®ä¿æœ€ç»ˆè¾“å‡ºçš„JSONä¸­`fileType`å­—æ®µæ­£ç¡®ã€‚

```python
# ... in processors.py
def parse_file(self, file_path: str) -> Dict[str, Any]:
    # ...
    file_type = self._detect_file_type(file_path)
    
    if file_type == "arxml":
        return self._parse_arxml_file(str(file_path), "arxml")
    elif file_type == "bmd":  # <-- æ–°å¢çš„åˆ†æ”¯
        # BMDä½¿ç”¨ARXMLè§£æå™¨ï¼Œä½†å¿…é¡»ä¼ é€’æ­£ç¡®çš„ç±»å‹ "bmd"
        return self._parse_arxml_file(str(file_path), "bmd") 
    elif file_type == "xdm":
        return self._parse_xdm_file(str(file_path))
    else:
        return self._parse_xml_file(str(file_path), "xml")
    # ...
```

**æ³¨æ„**: å¦‚æœæ–°æ ¼å¼éœ€è¦ä¸€ä¸ªå…¨æ–°çš„è§£æå™¨ï¼Œæ‚¨éœ€è¦ï¼š
1.  åœ¨`lib/`ä¸‹åˆ›å»ºæ–°çš„`some_format_processor.py`ã€‚
2.  åœ¨`processors.py`ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„`_parse_some_format_file()`æ–¹æ³•ã€‚
3.  åœ¨`parse_file`ä¸­è°ƒç”¨è¿™ä¸ªæ–°æ–¹æ³•ã€‚

### ç¬¬ä¸‰æ­¥ï¼šç¡®ä¿è§£æå‡½æ•°æ”¯æŒ`file_type`å‚æ•°

-   **æ–‡ä»¶**: `python-backend/processors.py`
-   **æ–¹æ³•**: `_parse_arxml_file` (æˆ–æ‚¨å¤ç”¨çš„ä»»ä½•è§£æå‡½æ•°)

ä¸ºäº†è®©ç¬¬äºŒæ­¥çš„`file_type`ä¼ é€’ç”Ÿæ•ˆï¼Œéœ€è¦ç¡®ä¿ç›®æ ‡è§£æå‡½æ•°èƒ½å¤Ÿæ¥æ”¶å®ƒï¼Œå¹¶åœ¨è¿”å›çš„JSONä¸­æ­£ç¡®ä½¿ç”¨ã€‚

**ç¤ºä¾‹ï¼šä¿®æ”¹`_parse_arxml_file`**

æˆ‘ä»¬å°†å®ƒçš„`fileType`å­—æ®µä»ç¡¬ç¼–ç çš„`"arxml"`æ”¹ä¸ºäº†åŠ¨æ€çš„`file_type`å‚æ•°ã€‚

```python
# ... in processors.py
# å¢åŠ  file_type å‚æ•°ï¼Œå¹¶æä¾›é»˜è®¤å€¼ä»¥ä¿æŒå‘åå…¼å®¹
def _parse_arxml_file(self, file_path: str, file_type: str = "arxml") -> Dict[str, Any]:
    # ...
    # ... è§£æé€»è¾‘ ...
    # ...
    
    return {
        "success": True,
        "fileType": file_type,  # <-- ä½¿ç”¨ä¼ å…¥çš„å‚æ•°
        "filePath": file_path,
        "treeStructure": tree_structure,
        "metadata": { ... }
    }
```

## æµ‹è¯•ä¸éªŒè¯

å®Œæˆä»£ç ä¿®æ”¹åï¼Œ**å¿…é¡»**é€šè¿‡`cli_wrapper.py`è¿›è¡Œæµ‹è¯•ã€‚è¿™æ˜¯éªŒè¯åç«¯ä¿®æ”¹æ˜¯å¦æˆåŠŸçš„å”¯ä¸€æ ‡å‡†ã€‚

1.  **è¿›å…¥åç«¯ç›®å½•**:
    ```bash
    cd python-backend
    ```

2.  **æ‰§è¡Œè§£æå‘½ä»¤**: ä½¿ç”¨`jq`å·¥å…·å¯ä»¥æ–¹ä¾¿åœ°æŸ¥çœ‹å…³é”®å­—æ®µã€‚
    -   **éªŒè¯è§£ææ˜¯å¦æˆåŠŸ**:
        ```bash
        python3 cli_wrapper.py parse --file <ä½ çš„æ–°æ ¼å¼æ–‡ä»¶è·¯å¾„> | jq '.success'
        # é¢„æœŸè¾“å‡º: true
        ```
    -   **éªŒè¯æ–‡ä»¶ç±»å‹æ˜¯å¦æ­£ç¡®**:
        ```bash
        python3 cli_wrapper.py parse --file <ä½ çš„æ–°æ ¼å¼æ–‡ä»¶è·¯å¾„> | jq '.fileType'
        # é¢„æœŸè¾“å‡º: "bmd" (æˆ–ä½ çš„æ–°æ ¼å¼ç±»å‹)
        ```
    -   **éªŒè¯åŸºæœ¬ç»“æ„æ ‘æ˜¯å¦ç”Ÿæˆ**:
        ```bash
        python3 cli_wrapper.py parse --file <ä½ çš„æ–°æ ¼å¼æ–‡ä»¶è·¯å¾„> | jq '{success, fileType, rootName: .treeStructure.name}'
        # é¢„æœŸè¾“å‡ºç±»ä¼¼:
        # {
        #   "success": true,
        #   "fileType": "bmd",
        #   "rootName": "AUTOSARé…ç½®"
        # }
        ```

3.  **GUIæ— ç¼å…¼å®¹æ€§æµ‹è¯•**:
    -   ç›´æ¥ä½¿ç”¨`backend_test_gui.py`æ‰“å¼€æ–°æ ¼å¼çš„æ–‡ä»¶ï¼Œå®ƒåº”è¯¥èƒ½å¤Ÿè¢«æ­£ç¡®è§£æå’Œæ˜¾ç¤ºï¼Œæ— éœ€å¯¹GUIè„šæœ¬è¿›è¡Œä»»ä½•ä¿®æ”¹ã€‚

é€šè¿‡è¿™å¥—æµç¨‹ï¼Œæˆ‘ä»¬ä¿è¯äº†åç«¯çš„å¯æ‰©å±•æ€§ã€å¯ç»´æŠ¤æ€§å’Œå¥å£®æ€§ï¼Œå®Œç¾å®è·µäº†"å…³æ³¨ç‚¹åˆ†ç¦»"çš„è®¾è®¡åŸåˆ™ã€‚ 

## ç¬¬å››æ­¥ï¼ˆå¯é€‰ï¼‰ï¼šæ›´æ–°å‰ç«¯ï¼ˆVS Codeæ’ä»¶ï¼‰é…ç½®

å¦‚æœæ‚¨çš„ç›®æ ‡æ˜¯è®©VS Codeæ’ä»¶ç›´æ¥æ”¯æŒæ–°æ–‡ä»¶æ ¼å¼ï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡åŒå‡»æ–‡ä»¶ç›´æ¥ç”¨æˆ‘ä»¬çš„è‡ªå®šä¹‰ç¼–è¾‘å™¨æ‰“å¼€ï¼‰ï¼Œæ‚¨è¿˜éœ€è¦æ›´æ–°æ’ä»¶çš„é…ç½®æ–‡ä»¶ã€‚

-   **æ–‡ä»¶**: `package.json` (ä½äºé¡¹ç›®æ ¹ç›®å½•)
-   **é…ç½®é¡¹**: `contributes.customEditors`

åœ¨`customEditors`çš„`selector`æ•°ç»„ä¸­ï¼Œä¸ºæ‚¨æƒ³æ”¯æŒçš„æ–°æ–‡ä»¶æ‰©å±•åæ·»åŠ ä¸€ä¸ªæ–°çš„`filenamePattern`ã€‚

**ç¤ºä¾‹ï¼šä¸º`.bmd`å’Œ`.xml`æ·»åŠ ç¼–è¾‘å™¨æ”¯æŒ**

```json
// ... in package.json
"customEditors": [
  {
    "viewType": "arxmlTreePreview",
    "displayName": "ARXMLæ ‘å½¢é¢„è§ˆ",
    "selector": [
      {
        "filenamePattern": "*.arxml"
      },
      {
        "filenamePattern": "*.xdm"
      },
      {
        "filenamePattern": "*.bmd" // <-- æ–°å¢
      },
      {
        "filenamePattern": "*.xml" // <-- æ–°å¢
      }
    ],
    "priority": "default"
  }
],
// ...
```

**é‡è¦æç¤º**ï¼šä¿®æ”¹ `package.json` åï¼Œæ‚¨éœ€è¦**é‡æ–°åŠ è½½æˆ–é‡å¯VS Code**æ‰èƒ½ä½¿è¿™äº›æ›´æ”¹ç”Ÿæ•ˆã€‚

## æ€»ç»“

é€šè¿‡è¿™å››ä¸ªæ­¥éª¤ï¼Œæ‚¨å¯ä»¥å®ç°å¯¹ä»»æ„æ–°æ–‡ä»¶æ ¼å¼çš„ç«¯åˆ°ç«¯æ”¯æŒã€‚æ•´ä¸ªè¿‡ç¨‹çš„æ ¸å¿ƒåœ¨äºä¿æŒåç«¯è¾“å‡ºçš„**JSONæ ¼å¼ç»Ÿä¸€**ï¼Œè¿™ä½¿å¾—å‰ç«¯çš„é€‚é…å·¥ä½œå˜å¾—æå…¶ç®€å•ï¼Œç”šè‡³å®Œå…¨ä¸éœ€è¦ï¼ˆå¦‚æœåªæ˜¯åœ¨å·²æœ‰åŠŸèƒ½ä¸Šæ‰©å±•ï¼‰ã€‚

æˆ‘ä»¬ä¿è¯äº†åç«¯çš„å¯æ‰©å±•æ€§ã€å¯ç»´æŠ¤æ€§å’Œå¥å£®æ€§ï¼Œå®Œç¾å®è·µäº†"å…³æ³¨ç‚¹åˆ†ç¦»"çš„è®¾è®¡åŸåˆ™ã€‚ç°åœ¨ï¼Œå¼€é¦™æ§Ÿåº†ç¥å§ï¼ğŸ‰ 